--procedure ORACLE

create or replace PROCEDURE PROC_T_CONSUMO_HOSPITALAR (DATAINI DATE, DATAFIM DATE) 
AS

BEGIN     

   DELETE FROM T_CONSUMO_HOSPITALAR WHERE DTATENDIMENTO BETWEEN DATAINI AND DATAFIM;


    INSERT /*+ APPEND */ INTO T_CONSUMO_HOSPITALAR
        SELECT P.TPATENDIMENTO, 
               NVL(P.CDATENDIMENTO, P.CDPACIENTE || '_' || P.CODATENDIMENTO) CDATENDIMENTO, 
               CASE WHEN P.FILIAL = 1111 THEN 14 ELSE P.FILIAL END FILIAL,
               P.DTPACIENTEADMISSAO DTATENDIMENTO, 
               P.CDPACIENTE, 
               P.NOPACIENTE, 
               P.CDSEXO, 
               P.DTNASCIMENTO, 
               P.CDCID,
               CID.DESCRICAOCID NOCID, 
               P.DTALTA, 
               P.CDCONVENIO,
               P.CODATENDIMENTO,
               P.NOCONVENIO, 
               P.CDUNIDADEATENDIMENTO,
               P.NOUNIDADEATENDIMENTO,
               P.DTPACIENTEADMISSAO, 
               P.DTALTA DTPACIENTESAIDA, 
               P.NUMEROCONTA,
               P.SEQUENCIALCONTA, 
               P.SEQUENCIALDEBITO,
               P.DTLANCAMENTO,
               P.CDCHAVEORIGEM, 
               CC.CODINTEGRACAO CDCENTROCUSTO, 
               P.CDTABELAINSUMO CDTABELAINSUMO, 
               TPRECO.DESCTABELA NOTABELAINSUMO, 
               P.CDGRUPOINSUMO, 
               RTRIM(LTRIM(P.NOGRUPOINSUMO)) NOGRUPOINSUMO, 
               P.NOTIPOINSUMO,
               P.IDPRD,
               P.CODITEM,
               P.CDINSUMO,
               P.NOINSUMO, 
               SUM(P.QTUTILIZADA) QTUTILIZADA, 
               SUM(P.VLCUSTOUNITARIO) VLCUSTOUNITARIO, 
               SUM(P.VLCUSTOTOTAL) VLCUSTOTOTAL, 
               SUM(P.QTCOBRADA) QTCOBRADA,
               SUM(P.VLCOBRADOUNITARIO) VLCOBRADOUNITARIO,
               SUM(P.VLCOBRADOTOTAL) VLCOBRADOTOTAL,
               'PG' STATUSITEM, 
               P.CDUNIDADEMEDIDA,
               P.NOUNIDADEMEDIDA,
               P.CDPROCEDIMENTOGRUPO,
               P.NOPROCEDIMENTOGRUPO, 
               P.CDPROCEDIMENTO, 
               P.NOPROCEDIMENTO, 
               P.TIPOPROCEDIMENTO,
               P.TEMPO, 
               P.DTPROCEDIMENTOINICIO,
               P.DTPROCEDIMENTOFIM, 
               P.CDMEDICO,
               P.NOMEDICO, 
               P.CDPERIODOCOMPETENCIA, 
               P.CODPRESTADOR,
               P.FATURA, 
               P.DATAEMISSAO,
               P.ITEMFORACONTA,
               P.SEQPARCIAL
        FROM     
        (    
            /* RECEITA ------------------------------------------------------------------------------------------------------------------------------------------------------ */
            /* VALORES DE EXAMES */
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL, 
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, SA.SEQDEBITOSADT SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   SA.DATAREALIZACAOSADT DTLANCAMENTO, 
                   SA.NUMEROCONTA || '-' || SA.SEQUENCIALCONTA || '-' || SA.SEQDEBITOSADT CDCHAVEORIGEM, 
                   SA.CODCENTCUSTRESULTADO, 
                   CASE WHEN PRDIF.CODTABPROCEDIMENTO IS NULL THEN CONT.CODTABPROCEDIMENTO ELSE PRDIF.CODTABPROCEDIMENTO END CDTABELAINSUMO, 
                   9 CDGRUPOINSUMO, 
                   'EXAMES' NOGRUPOINSUMO, 
                   'EXAMES' NOTIPOINSUMO,
                   0 IDPRD, 
                   SA.CODESPECIALIDADE || SA.CODGRUPOITENS || SA.CODITEM CODITEM, 
                   (SA.CODESPECIALIDADE || '.' || SA.CODGRUPOITENS || '.' || SA.CODITEM) CDINSUMO, 
                   SA.DISCRIMINACAOSADT NOINSUMO, 
                   0 QTUTILIZADA, 
                   0 VLCUSTOUNITARIO, 
                   0 VLCUSTOTOTAL, 
                   SA.QUANTIDADESADT QTCOBRADA,
                   SA.VALORSADT VLCOBRADOUNITARIO, 
                   SA.VALORTOTALSADT VLCOBRADOTOTAL, 
                   NULL CDUNIDADEMEDIDA, 
                   NULL NOUNIDADEMEDIDA, 
                   NULL CDPROCEDIMENTOGRUPO,
                   NULL NOPROCEDIMENTOGRUPO, 
                   NULL CDPROCEDIMENTO, 
                   NULL NOPROCEDIMENTO, 
                   NULL TIPOPROCEDIMENTO,
                   NULL TEMPO,
                   SA.DATAREALIZACAOSADT DTPROCEDIMENTOINICIO, 
                   SA.DATAREALIZACAOSADT DTPROCEDIMENTOFIM, 


                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.MEDREP                        
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.CPF 
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.CGC END CDMEDICO,  

                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.NOME
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.RAZAOSOCIAL
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.RAZAOSOCIAL END NOMEDICO,

                   TO_CHAR(SA.DATAREALIZACAOSADT,'YYYYMM') CDPERIODOCOMPETENCIA, 
                   SA.CODPRESTADOR,
                   SA.EXAMEFORA ITEMFORACONTA,
                   SA.INCLUIDOPACOTE 
            FROM RM.T_ATENDIMENTO PAC 
              INNER JOIN SZATENDSADT SA 
                ON PAC.NUMEROCONTA = SA.NUMEROCONTA AND PAC.SEQUENCIALCONTA = SA.SEQUENCIALCONTA AND PAC.SEQPARCIAL = SA.SEQPARCIAL AND PAC.CODCOLIGADA = SA.CODCOLIGADA
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
              LEFT JOIN SZTABPRECODIF PRDIF
                ON PAC.CODPLANO = PRDIF.CODPLANO AND PAC.CDCONVENIO = PRDIF.CODCONVENIO AND PAC.CODCOLIGADA = PRDIF.CODCOLIGADA
              LEFT JOIN SZCONDCONTRAT CONT_PRDIF
                ON PRDIF.CODTIPOCONTRATO = CONT_PRDIF.CODTIPOCONTRATO AND PRDIF.CODCOLIGADA = CONT_PRDIF.CODCOLIGADA AND CONT_PRDIF.IDUNIDATEND = PAC.FILIAL
              LEFT JOIN SZCONTROLREPASSE CR
                ON PAC.NUMEROCONTA = CR.NUMEROCONTA AND PAC.SEQUENCIALCONTA = CR.SEQUENCIALCONTA AND SA.SEQDEBITOSADT = CR.SEQDEBITO AND PAC.SEQPARCIAL = CR.SEQPARCIAL AND PAC.CODCOLIGADA = CR.CODCOLIGADA
                   AND (SA.CODESPECIALIDADE || SA.CODGRUPOITENS || SA.CODITEM) = CR.CODITEM AND SA.DATAREALIZACAOSADT = CR.DATALANC AND CR.CODPRESTADOR <> 1 
              LEFT JOIN SZCADGERAL MEDREP /* MEDICO REPASSE */
                ON CR.CODPRESTADOR = MEDREP.CODGERAL AND CR.CODCOLIGADA = MEDREP.CODCOLIGADA
              LEFT JOIN SZCADGERAL MEDEX /* MEDICO EXECUTANTE */
                ON SA.CODPRESTADOR = MEDEX.CODGERAL AND SA.CODCOLIGADA = MEDEX.CODCOLIGADA 
              LEFT JOIN RM.T_MEDREPASSE MED /* TABELA TEMPORÁRIA DOS MEDICOS DE REPASSE */ 
                ON MEDEX.CODGERAL = MED.MEDEXE AND MEDEX.CODCOLIGADA = 1
            WHERE (SA.VALORSADT > 0 AND VALORTOTALSADT > 0)
              AND SA.DATAREALIZACAOSADT BETWEEN SYSDATE -150 AND SYSDATE
              AND SA.ESTORNADO IS NULL
              /*AND (SA.EXAMEFORA = 'F' OR SA.EXAMEFORA IS NULL)*/
              AND ( (PRDIF.CODTIPOCONTRATO IS NULL AND CONT_PRDIF.IDUNIDATEND IS NULL) OR (PRDIF.CODTIPOCONTRATO IS NOT NULL AND CONT_PRDIF.IDUNIDATEND IS NOT NULL) )
              AND ( /* ONDE NÃO EXISTA PACOTE LANÇADO NA CONTA DO PACIENTE. SE EXISTIR, DEVE SER CONSIDERADO SÓ O PACOTE NA ABA DE TAXAS (SADT), GASTOS PARTICULARES E ITENS INCLUIDOS AO PACOTE */
                     NOT EXISTS (
                                    SELECT 1 FROM SZATENDTAXASERV TS 
                                    WHERE PAC.NUMEROCONTA = TS.NUMEROCONTA 
                                      AND PAC.SEQUENCIALCONTA = TS.SEQUENCIALCONTA 
                                      AND PAC.SEQPARCIAL = TS.SEQPARCIAL 
                                      AND PAC.CODCOLIGADA = TS.CODCOLIGADA
                                      AND TS.CODGGASTO = 10 /* PACOTE */
                                      AND TS.ESTORNADO IS NULL 
                                 )

                     OR SA.INCLUIDOPACOTE = 'T'
                  ) AND SA.DATAREALIZACAOSADT BETWEEN DATAINI AND DATAFIM


            UNION ALL 


            /*  VALORES DE HONORÁRIOS MÉDICOS */ 
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL,
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, HO.SEQDEBITOHM SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   HO.DATAREALIZACAOHM DTLANCAMENTO, (HO.NUMEROCONTA || '-' || HO.SEQUENCIALCONTA || '-' || HO.SEQDEBITOHM) CDCHAVEORIGEM, 
                   HO.CODCENTCUSTRESULTADO, 

                   CASE WHEN PAC.CDCONVENIO = 4181 /* UNIMED */THEN CONT.CODTABPROCEDIMENTO 
                        ELSE (CASE WHEN PRDIF.CODTABESPECIAL IS NULL THEN CONT.CODTABESPECIAL ELSE PRDIF.CODTABESPECIAL END) END CDTABELAINSUMO, 

                   1 CDGRUPOINSUMO, 
                   'HONORARIOS' NOGRUPOINSUMO,
                   'HONORARIOS' NOTIPOINSUMO,
                   0 IDPRD, 
                   HO.CODESPECIALIDADE || HO.CODGRUPOITENS || HO.CODITEM CODITEM,
                   (HO.CODESPECIALIDADE || '.' || HO.CODGRUPOITENS || '.' || HO.CODITEM) CDINSUMO, HO.DISCRIMINACAOHM NOINSUMO,                 
                   0 QTUTILIZADA, 
                   0 VLCUSTOUNITARIO, 
                   0 VLCUSTOTOTAL,  
                   HO.QUANTIDADEHM QTCOBRADA, 
                   HO.VALORHM VLCOBRADOUNITARIO,
                   HO.VALORTOTALHM VLCOBRADOTOTAL, 
                   NULL CDUNIDADEMEDIDA,
                   NULL NOUNIDADEMEDIDA, 
                   PAC.CODESPECGRUPO CDPROCEDIMENTOGRUPO, 
                   PAC.DESCESPECGRUPO NOPROCEDIMENTOGRUPO, 
                   (HO.CODESPECIALIDADE || '.' || HO.CODGRUPOITENS || '.' || HO.CODITEM) CDPROCEDIMENTO, 
                   HO.DISCRIMINACAOHM NOPROCEDIMENTO, 
                   HO.TIPOPROCEDIMENTO,
                   NULL TEMPO,         
                   HO.DATAREALIZACAOHM DTPROCEDIMENTOINICIO,
                   HO.DATAREALIZACAOHM DTPROCEDIMENTOFIM, 

                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.MEDREP                        
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.CPF 
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.CGC END CDMEDICO,  

                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.NOME
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.RAZAOSOCIAL
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.RAZAOSOCIAL END NOMEDICO,

                   TO_CHAR(HO.DATAREALIZACAOHM,'YYYYMM') CDPERIODOCOMPETENCIA, 
                   HO.CODPRESTADOR,
                   HO.HONORARIOFORA ITEMFORACONTA,
                   HO.INCLUIDOPACOTE
            FROM RM.T_ATENDIMENTO PAC
              INNER JOIN SZATENDHONORARIO HO 
                ON PAC.NUMEROCONTA = HO.NUMEROCONTA AND PAC.SEQUENCIALCONTA = HO.SEQUENCIALCONTA AND PAC.SEQPARCIAL = HO.SEQPARCIAL AND PAC.CODCOLIGADA = HO.CODCOLIGADA
              /*LEFT JOIN SZCADGERAL MED
                ON HO.CODPRESTADOR = MED.CODGERAL AND HO.CODCOLIGADA = MED.CODCOLIGADA       */       
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
              LEFT JOIN SZTABPRECODIF PRDIF
                ON PAC.CODPLANO = PRDIF.CODPLANO AND PAC.CDCONVENIO = PRDIF.CODCONVENIO AND PAC.CODCOLIGADA = PRDIF.CODCOLIGADA
              LEFT JOIN SZCONDCONTRAT CONT_PRDIF
                ON PRDIF.CODTIPOCONTRATO = CONT_PRDIF.CODTIPOCONTRATO AND PRDIF.CODCOLIGADA = CONT_PRDIF.CODCOLIGADA AND CONT_PRDIF.IDUNIDATEND = PAC.FILIAL      
              LEFT JOIN SZCONTROLREPASSE CR
                ON PAC.NUMEROCONTA = CR.NUMEROCONTA AND PAC.SEQUENCIALCONTA = CR.SEQUENCIALCONTA AND HO.SEQDEBITOHM = CR.SEQDEBITO AND PAC.SEQPARCIAL = CR.SEQPARCIAL AND PAC.CODCOLIGADA = CR.CODCOLIGADA
                   AND (HO.CODESPECIALIDADE || HO.CODGRUPOITENS || HO.CODITEM) = CR.CODITEM AND HO.DATAREALIZACAOHM = CR.DATALANC AND CR.CODPRESTADOR <> 1
              LEFT JOIN SZCADGERAL MEDREP /* MEDICO REPASSE */
                ON CR.CODPRESTADOR = MEDREP.CODGERAL AND CR.CODCOLIGADA = MEDREP.CODCOLIGADA
              LEFT JOIN SZCADGERAL MEDEX /* MEDICO EXECUTANTE */
                ON HO.CODPRESTADOR = MEDEX.CODGERAL AND HO.CODCOLIGADA = MEDEX.CODCOLIGADA  
              LEFT JOIN RM.T_MEDREPASSE MED /* TABELA TEMPORÁRIA DOS MEDICOS DE REPASSE */
                ON MEDEX.CODGERAL = MED.MEDEXE AND MEDEX.CODCOLIGADA = 1
            WHERE HO.DATAREALIZACAOHM BETWEEN SYSDATE -150 AND SYSDATE
              AND HO.ESTORNADO IS NULL
              AND ( (PRDIF.CODTIPOCONTRATO IS NULL AND CONT_PRDIF.IDUNIDATEND IS NULL) OR (PRDIF.CODTIPOCONTRATO IS NOT NULL AND CONT_PRDIF.IDUNIDATEND IS NOT NULL) )         
              AND ( /* ONDE NÃO EXISTA PACOTE LANÇADO NA CONTA DO PACIENTE. SE EXISTIR, DEVE SER CONSIDERADO SÓ O PACOTE NA ABA DE TAXAS (SADT), GASTOS PARTICULARES E ITENS INCLUIDOS AO PACOTE */
                     NOT EXISTS (
                                    SELECT 1 FROM SZATENDTAXASERV TS 
                                    WHERE PAC.NUMEROCONTA = TS.NUMEROCONTA 
                                      AND PAC.SEQUENCIALCONTA = TS.SEQUENCIALCONTA 
                                      AND PAC.SEQPARCIAL = TS.SEQPARCIAL 
                                      AND PAC.CODCOLIGADA = TS.CODCOLIGADA
                                      AND TS.CODGGASTO = 10 /* PACOTE */
                                      AND TS.ESTORNADO IS NULL 
                                )

                     OR HO.INCLUIDOPACOTE = 'T'
                  ) AND HO.DATAREALIZACAOHM BETWEEN DATAINI AND DATAFIM


            UNION ALL 


            /* VALORES DE MATERIAIS E MEDICAMENTOS */
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL, 
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, MM.SEQDEBITOMATMED SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   MM.DATAMATMED DTLANCAMENTO, (MM.NUMEROCONTA || '-' || MM.SEQUENCIALCONTA || '-' || MM.SEQDEBITOMATMED) CDCHAVEORIGEM, 
                   MM.CODCENTCUSTRESULTADO,                 

                   CASE WHEN MM.CODGGASTO = 05 THEN (CASE WHEN CONT.CODTABMED BETWEEN 1 AND 9 THEN '0' || TO_CHAR(CONT.CODTABMED) ELSE TO_CHAR(CONT.CODTABMED) END) 
                        WHEN MM.CODGGASTO = 06 THEN (CASE WHEN CONT.CODTABMATMED BETWEEN 1 AND 9 THEN '0' || TO_CHAR(CONT.CODTABMATMED) ELSE TO_CHAR(CONT.CODTABMATMED) END) 
                        ELSE CONT.CODTABESPECIAL END CDTABELAINSUMO, 

                   TO_NUMBER(MM.CODGGASTO) CDGRUPOINSUMO, 
                   GG.DESCGRUPOGASTO NOGRUPOINSUMO,  
                   GG.DESCGRUPOGASTO NOTIPOINSUMO,
                   MM.IDPRD,
                   MM.CODESPECMATMED || MM.CODGRUPOMATMED || MM.CODITEMMATMED CODITEM,
                   NVL(TPRD.CODIGOPRD, MM.CODESPECMATMED || '.' || MM.CODGRUPOMATMED || '.' || MM.CODITEMMATMED) CDINSUMO,
                   NVL(TPRD.DESCRICAO, MM.DISCRIMINACAOMATMED) NOINSUMO, 
                   (MM.QUANTIDADEMATMED - MM.QTDDEVOLVIDA) QTUTILIZADA, 
                   RM.TPRD.CUSTOUNITARIO VLCUSTOUNITARIO, 
                   RM.TPRD.CUSTOUNITARIO * (MM.QUANTIDADEMATMED - MM.QTDDEVOLVIDA) VLCUSTOTOTAL,
                   (MM.QUANTIDADEMATMED - MM.QTDDEVOLVIDA) QTCOBRADA, 
                   MM.VALORMATMED VLCOBRADOUNITARIO, 
                   (MM.QUANTIDADEMATMED - MM.QTDDEVOLVIDA) * MM.VALORMATMED VLCOBRADOTOTAL,
                   MM.UNIDADEFATURAMENTO CDUNIDADEMEDIDA, 
                   TUND.DESCRICAO NOUNIDADEMEDIDA, 
                   NULL CDPROCEDIMENTOGRUPO, 
                   NULL NOPROCEDIMENTOGRUPO, 
                   NULL CDPROCEDIMENTO,
                   NULL NOPROCEDIMENTO, 
                   NULL TIPOPROCEDIMENTO,
                   NULL TEMPO,
                   MM.DATAMATMED DTPROCEDIMENTOINICIO,
                   MM.DATAMATMED DTPROCEDIMENTOFIM, 
                   NULL CDMEDICO,
                   NULL NOMEDICO,
                   TO_CHAR(MM.DATAMATMED,'YYYYMM') CDPERIODOCOMPETENCIA, 
                   0 CODPRESTADOR,
                   '' ITEMFORACONTA,
                   MM.INCLUIDOPACOTE
            FROM T_ATENDIMENTO PAC
              INNER JOIN SZATENDMATMED MM 
                ON PAC.NUMEROCONTA = MM.NUMEROCONTA AND PAC.SEQUENCIALCONTA = MM.SEQUENCIALCONTA AND PAC.SEQPARCIAL = MM.SEQPARCIAL AND PAC.CODCOLIGADA = MM.CODCOLIGADA
              LEFT JOIN SZPRD
                ON MM.IDPRD = SZPRD.IDPRD AND MM.CODCOLIGADA = SZPRD.CODCOLIGADA
              LEFT JOIN RM.TPRD 
                ON SZPRD.IDPRD = TPRD.IDPRD AND SZPRD.CODCOLIGADA = TPRD.CODCOLIGADA
              LEFT JOIN TPRODUTODEF TDEF
                ON TPRD.IDPRD = TDEF.IDPRD AND TPRD.CODCOLIGADA = TDEF.CODCOLIGADA
              LEFT JOIN TUND
                ON TDEF.CODUNDCOMPRA = TUND.CODUND
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
              LEFT JOIN SZMOVIESTOQUEITEM MSI
                ON MM.CODREQUISICAO = MSI.CODREQUISICAO AND MM.IDPRD = MSI.IDPRD AND MM.CODCOLIGADA = MSI.CODCOLIGADA
              INNER JOIN SZGRUPOGASTO GG
                ON MM.CODGGASTO = GG.CODGRUPOGASTO AND MM.CODCOLIGADA = GG.CODCOLIGADA
              LEFT JOIN SZMOVIESTOQUE ME
                ON MSI.CODREQUISICAO = ME.CODREQUISICAO AND MSI.CODCOLIGADA = ME.CODCOLIGADA
            WHERE MM.VALORMATMED > 0
              AND MM.DATAMATMED BETWEEN SYSDATE -150 AND SYSDATE
			        AND ( ( (MM.BAIXADEV IS NULL OR MM.BAIXADEV = 'F') AND MM.CODREQUISICAO IS NULL) OR (MM.CODREQUISICAO IS NOT NULL AND MSI.DATADEVOLUCAO IS NULL) OR (MM.CODREQUISICAO IS NOT NULL AND MSI.DATADEVOLUCAO IS NOT NULL AND ME.CODMOTIVODEVOL IS NULL)) /* VERIFICA SENÃO FOI DEVOLVIDO */
              AND MM.ESTORNADO IS NULL 
              AND MM.QTDDEVOLVIDA <> MM.QUANTIDADEMATMED
              AND ( /* ONDE NÃO EXISTA PACOTE LANÇADO NA CONTA DO PACIENTE. SE EXISTIR, DEVE SER CONSIDERADO SÓ O PACOTE NA ABA DE TAXAS (SADT), GASTOS PARTICULARES E ITENS INCLUIDOS AO PACOTE */
                     NOT EXISTS ( 
                                    SELECT 1 FROM SZATENDTAXASERV TS 
                                    WHERE PAC.NUMEROCONTA = TS.NUMEROCONTA 
                                      AND PAC.SEQUENCIALCONTA = TS.SEQUENCIALCONTA 
                                      AND PAC.SEQPARCIAL = TS.SEQPARCIAL 
                                      AND PAC.CODCOLIGADA = TS.CODCOLIGADA
                                      AND TS.CODGGASTO = 10 /* PACOTE */
                                      AND TS.ESTORNADO IS NULL 
                                 )

                     OR MM.INCLUIDOPACOTE = 'T' --OR MM.CODREQUISICAO IS NOT NULL)
                  )  AND MM.DATAMATMED BETWEEN DATAINI AND DATAFIM                 


              UNION ALL 


            /* VALORES DE DIARIAS */
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL,
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, DI.SEQDEBITODIARIA SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   DI.DATADIARIA DTLANCAMENTO, 
                   (DI.NUMEROCONTA || '-' || DI.SEQUENCIALCONTA || '-' || DI.SEQDEBITODIARIA) CDCHAVEORIGEM,
                   DI.CODCENTCUSTRESULTADO, 
                   CONT.CODTABSERVICOS CDTABELAINSUMO,
                   2 CDGRUPOINSUMO, 
                   'DIARIAS' NOGRUPOINSUMO,
                   'DIARIAS' NOTIPOINSUMO,
                   0 IDPRD, 
                   DI.CODESPECIALIDADE ||  DI.CODGRUPOITENS ||  DI.CODITEM CODITEM,
                   (DI.CODESPECIALIDADE || '.' || DI.CODGRUPOITENS || '.' || DI.CODITEM) CDINSUMO, 
                   DI.DISCRIMINACAODIARIA NOINSUMO,
                   DI.QUANTIDADEDIARIAS QTUTILIZADA, 
                   0 VLCUSTOUNITARIO,
                   0 VLCUSTOTOTAL,
                   DI.QUANTIDADEDIARIAS QTCOBRADA, 
                   DI.VALORDIARIAS VLCOBRADOUNITARIO,
                   DI.VALORTOTALDIARIAS VLCOBRADOTOTAL,
                   NULL CDUNIDADEMEDIDA, 
                   NULL NOUNIDADEMEDIDA,
                   NULL CDPROCEDIMENTOGRUPO, 
                   NULL NOPROCEDIMENTOGRUPO, 
                   NULL CDPROCEDIMENTO, 
                   NULL NOPROCEDIMENTO,
                   NULL TIPOPROCEDIMENTO,
                   NULL TEMPO,
                   DI.DATADIARIA DTPROCEDIMENTOINICIO, 
                   DI.DATADIARIA DTPROCEDIMENTOFIM, 
                   NULL CDMEDICO, 
                   NULL NOMEDICO, TO_CHAR(DI.DATADIARIA,'YYYYMM') CDPERIODOCOMPETENCIA, 
                   0 CODPRESTADOR,
                   '' ITEMFORACONTA,
                   DI.INCLUIDOPACOTE
            FROM RM.T_ATENDIMENTO PAC
              INNER JOIN SZATENDDIARIAS DI 
                ON PAC.NUMEROCONTA = DI.NUMEROCONTA AND PAC.SEQUENCIALCONTA = DI.SEQUENCIALCONTA AND PAC.SEQPARCIAL = DI.SEQPARCIAL AND PAC.CODCOLIGADA = DI.CODCOLIGADA
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
            WHERE (DI.VALORDIARIAS > 0 AND DI.VALORTOTALDIARIAS > 0)
              AND DI.DATADIARIA BETWEEN SYSDATE -150 AND SYSDATE
              AND DI.ESTORNADO IS NULL
              AND ( /* ONDE NÃO EXISTA PACOTE LANÇADO NA CONTA DO PACIENTE. SE EXISTIR, DEVE SER CONSIDERADO SÓ O PACOTE NA ABA DE TAXAS (SADT), GASTOS PARTICULARES E ITENS INCLUIDOS AO PACOTE */
                     NOT EXISTS ( 
                                    SELECT 1 FROM SZATENDTAXASERV TS 
                                    WHERE PAC.NUMEROCONTA = TS.NUMEROCONTA 
                                      AND PAC.SEQUENCIALCONTA = TS.SEQUENCIALCONTA 
                                      AND PAC.SEQPARCIAL = TS.SEQPARCIAL 
                                      AND PAC.CODCOLIGADA = TS.CODCOLIGADA
                                      AND TS.CODGGASTO = 10 /* PACOTE */
                                      AND TS.ESTORNADO IS NULL 
                                 )

                     OR DI.INCLUIDOPACOTE = 'T'
                  )   AND DI.DATADIARIA BETWEEN DATAINI AND DATAFIM


            UNION ALL 


            /* VALORES DE TAXAS */
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL, 
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, TS.SEQDEBITOTAXAS SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   TS.DATATAXA DTLANCAMENTO, (TS.NUMEROCONTA || '-' || TS.SEQUENCIALCONTA || '-' || TS.SEQDEBITOTAXAS) CDCHAVEORIGEM,
                   TS.CODCENTCUSTRESULTADO, CONT.CODTABSERVICOS CDTABELAINSUMO, TO_NUMBER(TS.CODGGASTO) CDGRUPOINSUMO, 

                   CASE WHEN TS.CODGGASTO = 03 THEN 'TAXAS' 
                        WHEN TS.CODGGASTO = 04 THEN 'SERVIÇOS'
                        WHEN TS.CODGGASTO = 10 THEN 'PACOTES'  ELSE ' ' END NOGRUPOINSUMO,

                   CASE WHEN TS.CODGGASTO = 03 THEN 'TAXAS' 
                        WHEN TS.CODGGASTO = 04 THEN 'SERVIÇOS'
                        WHEN TS.CODGGASTO = 10 THEN 'PACOTES'  ELSE ' ' END NOTIPOINSUMO,     
                   0 IDPRD, 
                   TS.CODESPECIALIDADE || TS.CODGRUPOITENS || TS.CODITEM CODITEM,
                   (TS.CODESPECIALIDADE || '.' || TS.CODGRUPOITENS || '.' || TS.CODITEM) CDINSUMO,
                   TS.DISCRIMINACAOTAXAS NOINSUMO,
                   TS.QUANTIDADETAXAS QTUTILIZADA,
                   0 VLCUSTOUNITARIO, 
                   0 VLCUSTOTOTAL,
                   TS.QUANTIDADETAXAS QTCOBRADA,
                   TS.VALORTAXAS VLCOBRADOUNITARIO, 
                   TS.VALORTOTALTAXAS VLCOBRADOTOTAL,
                   NULL CDUNIDADEMEDIDA, 
                   NULL NOUNIDADEMEDIDA,
                   NULL CDPROCEDIMENTOGRUPO, 
                   NULL NOPROCEDIMENTOGRUPO, 
                   NULL CDPROCEDIMENTO,
                   NULL NOPROCEDIMENTO,
                   NULL TIPOPROCEDIMENTO,
                   NULL TEMPO,
                   TS.DATATAXA DTPROCEDIMENTOINICIO,
                   TS.DATATAXA DTPROCEDIMENTOFIM,
                   NULL CDMEDICO,
                   NULL NOMEDICO, TO_CHAR(TS.DATATAXA,'YYYYMM') CDPERIODOCOMPETENCIA, 
                   0 CODPRESTADOR,
                   TS.TAXAFORA ITEMFORACONTA,
                   TS.INCLUIDOPACOTE
            FROM RM.T_ATENDIMENTO PAC
              INNER JOIN SZATENDTAXASERV TS 
                ON PAC.NUMEROCONTA = TS.NUMEROCONTA AND PAC.SEQUENCIALCONTA = TS.SEQUENCIALCONTA AND PAC.SEQPARCIAL = TS.SEQPARCIAL AND PAC.CODCOLIGADA = TS.CODCOLIGADA
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
            WHERE (TS.VALORTAXAS > 0 AND TS.VALORTOTALTAXAS > 0)
              AND TS.DATATAXA BETWEEN SYSDATE -150 AND SYSDATE
              AND TS.ESTORNADO IS NULL 
              AND (TS.TAXAFORA = 'F' OR TS.TAXAFORA IS NULL)
              /* DEVE SER CONSIDERADO SÓ O PACOTE (SE EXISTIR) E OS ITENS INCLUIDOS AO PACOTE, OU ITENS SENÃO EXISTER PACOTE */
              AND ( 
                      (TS.CODGGASTO = 10 OR (TS.CODGGASTO <> 10 AND TS.INCLUIDOPACOTE = 'T'))     
                      OR NOT EXISTS (  
                                        SELECT 1 FROM SZATENDTAXASERV TS 
                                        WHERE PAC.NUMEROCONTA = TS.NUMEROCONTA 
                                          AND PAC.SEQUENCIALCONTA = TS.SEQUENCIALCONTA 
                                          /* AND PAC.SEQPARCIAL = TS.SEQPARCIAL */
                                          AND PAC.CODCOLIGADA = TS.CODCOLIGADA
                                          AND TS.CODGGASTO = 10 
                                          AND TS.ESTORNADO IS NULL 
                                    )
                  )     AND TS.DATATAXA BETWEEN DATAINI AND DATAFIM           


              UNION ALL


            /* VALORES DE GASTOS PARTICULARES */
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL, 
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, GP.SEQLANCAMENTO SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   GP.DATALANCAMENTO DTLANCAMENTO, 
                   (GP.NUMEROCONTA || '-' || GP.SEQUENCIALCONTA || '-' || GP.SEQLANCAMENTO) CDCHAVEORIGEM, 
                   GP.CODCENTCUSTRESULTADO,
                   'TABPROPRIA' || PAC.FILIAL CDTABELAINSUMO, TO_NUMBER(GP.CODGASTO) CDGRUPOINSUMO, 
                   GG.DESCGRUPOGASTO NOGRUPOINSUMO,
                   'GASTOS PARTICULARES' NOTIPOINSUMO,
                   0 IDPRD, 
                   GP.CODESPECIALIDADE || GP.CODGRUPOITENS || GP.CODITEM CODITEM,
                   (GP.CODESPECIALIDADE || '.' || GP.CODGRUPOITENS || '.' || GP.CODITEM) CDINSUMO,
                   GP.DISCRIMINACAO NOINSUMO,
                   GP.QUANTIDADE QTUTILIZADA,
                   0 VLCUSTOUNITARIO, 
                   0 VLCUSTOTOTAL,
                   GP.QUANTIDADE QTCOBRADA, 
                   GP.VALOR VLCOBRADOUNITARIO, 
                   GP.VALORTOTAL VLCOBRADOTOTAL,
                   CASE WHEN GP.CODGASTO IN (05, 06) THEN UNIDADEFATURAMENTO ELSE NULL END CDUNIDADEMEDIDA, 
                   TUND.DESCRICAO NOUNIDADEMEDIDA, 
                   PAC.CODESPECGRUPO CDPROCEDIMENTOGRUPO, 
                   PAC.DESCESPECGRUPO NOPROCEDIMENTOGRUPO,
                   (GP.CODESPECIALIDADE || '.' || GP.CODGRUPOITENS || '.' || GP.CODITEM) CDPROCEDIMENTO,            
                   GP.DISCRIMINACAO NOPROCEDIMENTO, 
                   NULL TIPOPROCEDIMENTO,
                   NULL TEMPO,
                   GP.DATALANCAMENTO DTPROCEDIMENTOINICIO,
                   GP.DATALANCAMENTO DTPROCEDIMENTOFIM,             
                   MED.CPF CDMEDICO,
                   MED.RAZAOSOCIAL NOMEDICO,
                   TO_CHAR(GP.DATALANCAMENTO,'YYYYMM') CDPERIODOCOMPETENCIA, 
                   GP.CODPRESTADOR,
                   GP.HONORARIOFORA ITEMFORACONTA,
                   '' INCLUIDOPACOTE
            FROM RM.T_ATENDIMENTO PAC       
              INNER JOIN SZATENDGASTOPARTIC GP
                ON PAC.NUMEROCONTA = GP.NUMEROCONTA AND PAC.SEQUENCIALCONTA = GP.SEQUENCIALCONTA AND PAC.SEQPARCIAL = GP.SEQPARCIAL AND PAC.CODCOLIGADA = GP.CODCOLIGADA
              INNER JOIN SZGRUPOGASTO GG
                ON GP.CODGASTO = GG.CODGRUPOGASTO AND GP.CODCOLIGADA = GG.CODCOLIGADA
              LEFT JOIN SZPRD
                ON GP.IDPRD = SZPRD.IDPRD AND GP.CODCOLIGADA = SZPRD.CODCOLIGADA
              LEFT JOIN RM.TPRD 
                ON SZPRD.IDPRD = TPRD.IDPRD AND SZPRD.CODCOLIGADA = TPRD.CODCOLIGADA
              LEFT JOIN TPRODUTODEF TDEF
                ON TPRD.IDPRD = TDEF.IDPRD AND TPRD.CODCOLIGADA = TDEF.CODCOLIGADA
              LEFT JOIN TUND
                ON TDEF.CODUNDCOMPRA = TUND.CODUND
              LEFT JOIN SZCADGERAL MED
                ON GP.CODPRESTADOR = MED.CODGERAL AND GP.CODCOLIGADA = MED.CODCOLIGADA    
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
            WHERE (GP.VALOR > 0 AND GP.VALORTOTAL > 0)
              AND GP.DATALANCAMENTO BETWEEN SYSDATE -150 AND SYSDATE
              AND (GP.BAIXADEV IS NULL OR BAIXADEV = 'F')
              AND GP.ESTORNADO IS NULL 
              AND (GP.HONORARIOFORA = 'F' OR GP.HONORARIOFORA IS NULL)
              AND GP.QTDDEVOLVIDA = 0
              AND TRANSLATE(''||UPPER(GP.DISCRIMINACAO)||'','Ç', 'C') NOT LIKE '%DIFERENCA%'   
              
              AND GP.DATALANCAMENTO BETWEEN DATAINI AND DATAFIM


              UNION ALL


            /* REPASSE -------------------------------------------------------------------------------------------------------------------------------------------------------- */   
            /* VALORES DE EXAMES */
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL,
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, SA.SEQDEBITOSADT SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   SA.DATAREALIZACAOSADT DTLANCAMENTO, 
                   SA.NUMEROCONTA || '-' || SA.SEQUENCIALCONTA || '-' || SA.SEQDEBITOSADT CDCHAVEORIGEM,
                   SA.CODCENTCUSTRESULTADO, 
                   CASE WHEN PRDIF.CODTABPROCEDIMENTO IS NULL THEN CONT.CODTABPROCEDIMENTO ELSE PRDIF.CODTABPROCEDIMENTO END CDTABELAINSUMO, 
                   9 CDGRUPOINSUMO, 
                   'EXAMES' NOGRUPOINSUMO,
                   'EXAMES' NOTIPOINSUMO,
                   0 IDPRD, 
                   SA.CODESPECIALIDADE || SA.CODGRUPOITENS || SA.CODITEM CODITEM,
                   (SA.CODESPECIALIDADE || '.' || SA.CODGRUPOITENS || '.' || SA.CODITEM) CDINSUMO,
                   SA.DISCRIMINACAOSADT NOINSUMO,    
                   SA.QUANTIDADESADT QTUTILIZADA,  
                   NVL(((CASE WHEN CR.VALORREPASSE < 0 THEN  CR.VALORREPASSE * -1 ELSE CR.VALORREPASSE END) / SA.QUANTIDADESADT), 0) VLCUSTOUNITARIO,
                   NVL(( CASE WHEN CR.VALORREPASSE < 0 THEN CR.VALORREPASSE * -1 ELSE CR.VALORREPASSE END), 0) VLCUSTOTOTAL,
                   0 QTCOBRADA, 
                   0 VLCOBRADOUNITARIO,
                   0 VLCOBRADOTOTAL,
                   NULL CDUNIDADEMEDIDA, 
                   NULL NOUNIDADEMEDIDA,
                   NULL CDPROCEDIMENTOGRUPO,
                   NULL NOPROCEDIMENTOGRUPO, 
                   NULL CDPROCEDIMENTO,
                   NULL NOPROCEDIMENTO,
                   NULL TIPOPROCEDIMENTO,
                   NULL TEMPO,
                   SA.DATAREALIZACAOSADT DTPROCEDIMENTOINICIO, 
                   SA.DATAREALIZACAOSADT DTPROCEDIMENTOFIM,


                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.MEDREP                        
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.CPF 
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.CGC END CDMEDICO,  

                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.NOME
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.RAZAOSOCIAL
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.RAZAOSOCIAL END NOMEDICO,

                   TO_CHAR(SA.DATAREALIZACAOSADT,'YYYYMM') CDPERIODOCOMPETENCIA,
                   SA.CODPRESTADOR,
                   SA.EXAMEFORA ITEMFORACONTA,
                   SA.INCLUIDOPACOTE
            FROM RM.T_ATENDIMENTO PAC 
              INNER JOIN SZATENDSADT SA 
                ON PAC.NUMEROCONTA = SA.NUMEROCONTA AND PAC.SEQUENCIALCONTA = SA.SEQUENCIALCONTA AND PAC.SEQPARCIAL = SA.SEQPARCIAL AND PAC.CODCOLIGADA = SA.CODCOLIGADA
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
              LEFT JOIN SZTABPRECODIF PRDIF
                ON PAC.CODPLANO = PRDIF.CODPLANO AND PAC.CDCONVENIO = PRDIF.CODCONVENIO AND PAC.CODCOLIGADA = PRDIF.CODCOLIGADA
              LEFT JOIN SZCONDCONTRAT CONT_PRDIF
                ON PRDIF.CODTIPOCONTRATO = CONT_PRDIF.CODTIPOCONTRATO AND PRDIF.CODCOLIGADA = CONT_PRDIF.CODCOLIGADA AND CONT_PRDIF.IDUNIDATEND = PAC.FILIAL
              INNER JOIN SZCONTROLREPASSE CR
                ON PAC.NUMEROCONTA = CR.NUMEROCONTA AND PAC.SEQUENCIALCONTA = CR.SEQUENCIALCONTA AND SA.SEQDEBITOSADT = CR.SEQDEBITO AND PAC.SEQPARCIAL = CR.SEQPARCIAL AND PAC.CODCOLIGADA = CR.CODCOLIGADA
                   AND (SA.CODESPECIALIDADE || SA.CODGRUPOITENS || SA.CODITEM) = CR.CODITEM AND SA.DATAREALIZACAOSADT = CR.DATALANC AND CR.CODPRESTADOR <> 1 
              INNER JOIN SZCADGERAL MEDREP /* MEDICO REPASSE */
                ON CR.CODPRESTADOR = MEDREP.CODGERAL AND CR.CODCOLIGADA = MEDREP.CODCOLIGADA
              INNER JOIN SZCADGERAL MEDEX /* MEDICO EXECUTANTE */
                ON SA.CODPRESTADOR = MEDEX.CODGERAL AND SA.CODCOLIGADA = MEDEX.CODCOLIGADA 
              LEFT JOIN RM.T_MEDREPASSE MED /* TABELA TEMPORÁRIA DOS MEDICOS DE REPASSE */
                ON MEDEX.CODGERAL = MED.MEDEXE AND MEDEX.CODCOLIGADA = 1
            WHERE SA.DATAREALIZACAOSADT BETWEEN SYSDATE -150 AND SYSDATE 
              AND SA.ESTORNADO IS NULL
              AND (SA.EXAMEFORA = 'F' OR SA.EXAMEFORA IS NULL)  
              AND ( (PRDIF.CODTIPOCONTRATO IS NULL AND CONT_PRDIF.IDUNIDATEND IS NULL) OR (PRDIF.CODTIPOCONTRATO IS NOT NULL AND CONT_PRDIF.IDUNIDATEND IS NOT NULL) ) 
              AND SA.CODPRESTADOR <> 1
              AND SA.QUANTIDADESADT <> 0
              
              AND SA.DATAREALIZACAOSADT BETWEEN DATAINI AND DATAFIM


              UNION ALL 


            /*  VALORES DE HONORÁRIOS MÉDICOS */
            SELECT DISTINCT PAC.TPATENDIMENTO, PAC.CDPACIENTE, PAC.NOPACIENTE, PAC.CDSEXO, PAC.DTNASCIMENTO, PAC.CDCID, PAC.DTALTA, PAC.CDCONVENIO, PAC.CODATENDIMENTO,
                   PAC.NOCONVENIO, PAC.CDUNIDADEATENDIMENTO, PAC.NOUNIDADEATENDIMENTO, PAC.DTPACIENTEADMISSAO, PAC.DTPACIENTESAIDA, PAC.PRONTUARIO CDATENDIMENTO, PAC.FILIAL, 
                   PAC.FATURA, PAC.DATAEMISSAO, PAC.NUMEROCONTA, PAC.SEQUENCIALCONTA, HO.SEQDEBITOHM SEQUENCIALDEBITO, PAC.SEQPARCIAL,

                   HO.DATAREALIZACAOHM DTLANCAMENTO, 
                   (HO.NUMEROCONTA || '-' || HO.SEQUENCIALCONTA || '-' || HO.SEQDEBITOHM) CDCHAVEORIGEM, 
                   HO.CODCENTCUSTRESULTADO, 

                   CASE WHEN PAC.CDCONVENIO = 4181 THEN CONT.CODTABPROCEDIMENTO/* UNIMED */
                        ELSE (CASE WHEN PRDIF.CODTABESPECIAL IS NULL THEN CONT.CODTABESPECIAL ELSE PRDIF.CODTABESPECIAL END) END CDTABELAINSUMO, 

                   1 CDGRUPOINSUMO, 
                   'HONORARIOS' NOGRUPOINSUMO, 
                   'HONORARIOS' NOTIPOINSUMO,
                   0 IDPRD, 
                   HO.CODESPECIALIDADE ||  HO.CODGRUPOITENS ||  HO.CODITEM CODITEM,
                   (HO.CODESPECIALIDADE || '.' || HO.CODGRUPOITENS || '.' || HO.CODITEM) CDINSUMO,
                   HO.DISCRIMINACAOHM NOINSUMO,
                   HO.QUANTIDADEHM QTUTILIZADA, 
                   NVL(((CASE WHEN CR.VALORREPASSE < 0 THEN  CR.VALORREPASSE * -1 ELSE CR.VALORREPASSE END) / HO.QUANTIDADEHM), 0) VLCUSTOUNITARIO,
                   NVL(( CASE WHEN CR.VALORREPASSE < 0 THEN CR.VALORREPASSE * -1 ELSE CR.VALORREPASSE END), 0) VLCUSTOTOTAL,
                   0 QTCOBRADA, 
                   0 VLCOBRADOUNITARIO, 
                   0 VLCOBRADOTOTAL, 
                   NULL CDUNIDADEMEDIDA,
                   NULL NOUNIDADEMEDIDA, 
                   PAC.CODESPECGRUPO CDPROCEDIMENTOGRUPO,
                   PAC.DESCESPECGRUPO NOPROCEDIMENTOGRUPO, 
                   (HO.CODESPECIALIDADE || '.' || HO.CODGRUPOITENS || '.' || HO.CODITEM) CDPROCEDIMENTO, 
                   HO.DISCRIMINACAOHM NOPROCEDIMENTO, 
                   HO.TIPOPROCEDIMENTO,
                   NULL TEMPO,         
                   HO.DATAREALIZACAOHM DTPROCEDIMENTOINICIO, 
                   HO.DATAREALIZACAOHM DTPROCEDIMENTOFIM,            


                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.MEDREP                        
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.CPF 
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.CGC END CDMEDICO,  

                   CASE WHEN MEDEX.CODGERAL = MED.MEDEXE THEN MED.NOME
                        WHEN MEDREP.CPF IS NOT NULL AND MEDREP.CGC IS NULL THEN MEDREP.RAZAOSOCIAL
                        WHEN MEDREP.CPF IS NULL AND MEDREP.CGC IS NOT NULL THEN MEDREP.RAZAOSOCIAL END NOMEDICO,

                   TO_CHAR(HO.DATAREALIZACAOHM,'YYYYMM') CDPERIODOCOMPETENCIA,
                   HO.CODPRESTADOR,
                   HO.HONORARIOFORA ITEMFORACONTA,
                   HO.INCLUIDOPACOTE
            FROM RM.T_ATENDIMENTO PAC
              INNER JOIN SZATENDHONORARIO HO 
                ON PAC.NUMEROCONTA = HO.NUMEROCONTA AND PAC.SEQUENCIALCONTA = HO.SEQUENCIALCONTA AND PAC.SEQPARCIAL = HO.SEQPARCIAL AND PAC.CODCOLIGADA = HO.CODCOLIGADA          
              INNER JOIN SZCONDCONTRAT CONT
                ON PAC.CDCONVENIO = CONT.CODCONVENIO AND PAC.FILIAL = CONT.IDUNIDATEND AND PAC.CODCOLIGADA = CONT.CODCOLIGADA
              LEFT JOIN SZTABPRECODIF PRDIF
                ON PAC.CODPLANO = PRDIF.CODPLANO AND PAC.CDCONVENIO = PRDIF.CODCONVENIO AND PAC.CODCOLIGADA = PRDIF.CODCOLIGADA
              LEFT JOIN SZCONDCONTRAT CONT_PRDIF
                ON PRDIF.CODTIPOCONTRATO = CONT_PRDIF.CODTIPOCONTRATO AND PRDIF.CODCOLIGADA = CONT_PRDIF.CODCOLIGADA AND CONT_PRDIF.IDUNIDATEND = PAC.FILIAL  
              INNER JOIN SZCONTROLREPASSE CR
                ON PAC.NUMEROCONTA = CR.NUMEROCONTA AND PAC.SEQUENCIALCONTA = CR.SEQUENCIALCONTA AND HO.SEQDEBITOHM = CR.SEQDEBITO AND PAC.SEQPARCIAL = CR.SEQPARCIAL AND PAC.CODCOLIGADA = CR.CODCOLIGADA
                   AND (HO.CODESPECIALIDADE || HO.CODGRUPOITENS || HO.CODITEM) = CR.CODITEM AND HO.DATAREALIZACAOHM = CR.DATALANC AND CR.CODPRESTADOR <> 1
              INNER JOIN SZCADGERAL MEDREP /* MEDICO REPASSE */
                ON CR.CODPRESTADOR = MEDREP.CODGERAL AND CR.CODCOLIGADA = MEDREP.CODCOLIGADA
              INNER JOIN SZCADGERAL MEDEX /* MEDICO EXECUTANTE */
                ON HO.CODPRESTADOR = MEDEX.CODGERAL AND HO.CODCOLIGADA = MEDEX.CODCOLIGADA            
              LEFT JOIN RM.T_MEDREPASSE MED /* TABELA TEMPORÁRIA DOS MEDICOS DE REPASSE */
                ON MEDEX.CODGERAL = MED.MEDEXE AND MEDEX.CODCOLIGADA = 1
            WHERE HO.DATAREALIZACAOHM BETWEEN SYSDATE -150 AND SYSDATE
              AND (HO.HONORARIOFORA = 'F' OR HO.HONORARIOFORA IS NULL)  
              AND HO.ESTORNADO IS NULL
              AND ( (PRDIF.CODTIPOCONTRATO IS NULL AND CONT_PRDIF.IDUNIDATEND IS NULL) OR (PRDIF.CODTIPOCONTRATO IS NOT NULL AND CONT_PRDIF.IDUNIDATEND IS NOT NULL) )           
              AND HO.CODPRESTADOR <> 1   
              AND HO.QUANTIDADEHM <> 0
              AND PAC.CDCONVENIO <> 592 /* CONVENIO PACOTE */
              
              AND HO.DATAREALIZACAOHM BETWEEN DATAINI AND DATAFIM
        )P /* CONTA DO PACIENTE*/

        INNER JOIN SZCENTROCUSTO CC
          ON P.CODCENTCUSTRESULTADO = CC.CODIGO AND CC.CODCOLIGADA = 1

        LEFT JOIN RM.SZCID CID
          ON P.CDCID = CID.CODCID

        LEFT JOIN SZTABPRECOUSADA TPRECO
          ON P.CDTABELAINSUMO = TPRECO.CODTABELA AND CC.CODCOLIGADA = TPRECO.CODCOLIGADA 

    WHERE (P.CDCHAVEORIGEM <> '00000050000001-17811-314546' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00000050000001-18774-333862' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00000050000001-18790-333843' OR P.CDMEDICO <>	09066796642)
      AND (P.CDCHAVEORIGEM <> '00000200000001-11713-330177' OR P.CDMEDICO <>	09066796642)
      AND (P.CDCHAVEORIGEM <> '00000200000001-11842-333865' OR P.CDMEDICO <>	09066796642)
      AND (P.CDCHAVEORIGEM <> '00000200000001-11850-333832' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00000310000001-11408-315810' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00000310000001-12557-332375' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00000310000001-12646-338506' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00041130000001-751-315649'   OR P.CDMEDICO <>	81957106700)
      AND (P.CDCHAVEORIGEM <> '00041130000001-751-315656'   OR P.CDMEDICO <>	81957106700)
      AND (P.CDCHAVEORIGEM <> '00041130000001-751-315664'   OR P.CDMEDICO <>	81957106700)
      AND (P.CDCHAVEORIGEM <> '00041310000001-27412-307929' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-31101-317920' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-33541-317758' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-33704-318432' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-33704-318443' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-33712-317824' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-33739-314548' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34052-318953' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34259-315465' OR P.CDMEDICO <>	89261860168)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34350-318602' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34408-318629' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34420-315827' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34693-318647' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34876-316673' OR P.CDMEDICO <>	89261860168)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34936-316751' OR P.CDMEDICO <>	89261860168)
      AND (P.CDCHAVEORIGEM <> '00041310000001-34940-316736' OR P.CDMEDICO <>	89261860168)
      AND (P.CDCHAVEORIGEM <> '00041310000001-35255-321907' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-35261-321946' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-35261-321954' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-35261-321958' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-35764-322261' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-36282-323258' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-36282-323315' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-36432-322364' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-36965-321623' OR P.CDMEDICO <>	11102923761)
      AND (P.CDCHAVEORIGEM <> '00041310000001-44755-333825' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00041310000001-44778-333866' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00041310000001-44784-333863' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00041310000001-44789-333834' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00041310000001-44792-333831' OR P.CDMEDICO <>	50651617120)
      AND (P.CDCHAVEORIGEM <> '00041310000001-44806-333835' OR P.CDMEDICO <>	50651617120)    
    GROUP BY P.TPATENDIMENTO, P.CDATENDIMENTO, P.CODATENDIMENTO, P.FILIAL, P.DTPACIENTEADMISSAO, P.CDPACIENTE, 
             P.NOPACIENTE, P.CDSEXO, P.DTNASCIMENTO, P.CDCID, CID.DESCRICAOCID, 
             P.DTALTA, P.CDCONVENIO, P.CODATENDIMENTO, P.NOCONVENIO, P.CDUNIDADEATENDIMENTO, P.NOUNIDADEATENDIMENTO, 
             P.DTPACIENTEADMISSAO, P.NUMEROCONTA, P.SEQUENCIALCONTA, P.SEQUENCIALDEBITO, P.DTLANCAMENTO, P.CDCHAVEORIGEM, CC.CODINTEGRACAO, 
             P.CDTABELAINSUMO, TPRECO.DESCTABELA, P.CDGRUPOINSUMO, P.NOGRUPOINSUMO, P.NOTIPOINSUMO, P.IDPRD, 
             P.CDINSUMO, P.NOINSUMO, 'PG', P.CDUNIDADEMEDIDA, P.NOUNIDADEMEDIDA, 
             P.CDPROCEDIMENTOGRUPO, P.NOPROCEDIMENTOGRUPO, P.CDPROCEDIMENTO, P.NOPROCEDIMENTO, P.TIPOPROCEDIMENTO, P.TIPOPROCEDIMENTO, P.TEMPO, 
             P.DTPROCEDIMENTOINICIO, P.DTPROCEDIMENTOFIM, P.CDMEDICO, P.NOMEDICO, P.CDPERIODOCOMPETENCIA, P.CODPRESTADOR,
             P.FATURA, P.DATAEMISSAO, P.CODITEM, P.ITEMFORACONTA, P.SEQPARCIAL;
    COMMIT;


    BEGIN
      EXECUTE IMMEDIATE 'DROP INDEX IDX_T_CONSUMO_HOSPITALAR';
      EXCEPTION WHEN OTHERS THEN NULL;
    END;  


    BEGIN
      EXECUTE IMMEDIATE 'CREATE INDEX IDX_T_CONSUMO_HOSPITALAR ON T_CONSUMO_HOSPITALAR 
      (
          NUMEROCONTA, SEQUENCIALCONTA, CDATENDIMENTO, FILIAL, CDPACIENTE, DTLANCAMENTO, CDCENTROCUSTO, CODITEM, IDPRD, CDINSUMO, CDPERIODOCOMPETENCIA
      ) STORAGE ( BUFFER_POOL KEEP) PCTFREE=0 COMPRESS';
      --DBMS_STATS.GATHER_TABLE_STATS('RM', 'T_CONSUMO_HOSPITALAR');
    END;

END;
