create or replace PROCEDURE PROC_ATUALIZA_OCUPACAO
IS
CURSOR CUR_OCUPACAO
     IS
      SELECT 'SUS' TIPO, SYSDATE DATA, U1.IDUNIDATEND SETOR, NVL(LEITOS_OCUPADOS, 0) OCUPADOS, NVL(LEITOS_LIVRES,0) LIVRES, NVL(LEITOS_SETOR,0) LEITOS_SETOR, NVL(EXTRAS,0) EXTRAS
   
   FROM SZUNIDATEND U1 
    LEFT OUTER JOIN
  (--LEITOS OCUPADOS NO DIA
     SELECT count(*) LEITOS_OCUPADOS, idunidatend
      FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%SUS%' AND 
      (STATUSLEITO LIKE 'O' AND NROLEITO NOT LIKE '%ALC%'  AND NROLEITO NOT LIKE '%RPA%' AND NROLEITO NOT LIKE '%MAC%'  AND BLOQLEITO NOT LIKE '%S%' AND BLOQLEITO NOT LIKE '%I%' AND NROLEITO NOT LIKE '%DAY%' AND NROLEITO NOT LIKE '%PPP%' AND NROLEITO NOT LIKE '%VIR%'  ))
      group by idunidatend) O ON O.IDUNIDATEND = U1.IDUNIDATEND
      
      LEFT JOIN
   
   (--LEITOS LIVRES
     SELECT count(*) LEITOS_LIVRES, IDUNIDATEND
      FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%SUS%' AND 
       (STATUSLEITO LIKE 'L' OR STATUSLEITO LIKE 'A' ) AND (NROLEITO NOT LIKE '%ALC%' AND NROLEITO NOT LIKE '%RPA%'AND NROLEITO NOT LIKE '%MAC%'  AND BLOQLEITO NOT LIKE '%S%' AND  BLOQLEITO NOT LIKE '%I%' AND NROLEITO NOT LIKE '%DAY%'  AND NROLEITO NOT LIKE '%PPP%' AND NROLEITO NOT LIKE '%VIR%'  ))
      group by idunidatend) L ON L.IDUNIDATEND = U1.IDUNIDATEND
      
      LEFT JOIN 
        
   (--LEITOS DO SETOR
    SELECT COUNT(*) LEITOS_SETOR, IDUNIDATEND
    FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%SUS%' AND 
       STATUSLEITO <> 'I' AND (NROLEITO NOT LIKE '%ALC%' AND NROLEITO NOT LIKE '%RPA%'AND NROLEITO NOT LIKE '%MAC%'  AND BLOQLEITO NOT LIKE '%I%'  AND BLOQLEITO NOT LIKE '%S%' AND NROLEITO NOT LIKE '%DAY%'  AND NROLEITO NOT LIKE '%PPP%' AND NROLEITO NOT LIKE '%VIR%'  ))
     group by idunidatend) LS ON LS.IDUNIDATEND = U1.IDUNIDATEND
    
      LEFT JOIN 
    
   (--LEITOS EXTRAS
    SELECT COUNT(*) EXTRAS, IDUNIDATEND
    FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%SUS%' AND 
     STATUSLEITO <> 'I'
     AND NROLEITO LIKE '%%EX%%' AND (NROLEITO NOT LIKE '%ALC%' AND NROLEITO NOT LIKE '%RPA%' AND NROLEITO NOT LIKE '%MAC%'  AND BLOQLEITO NOT LIKE '%I%'  AND BLOQLEITO NOT LIKE '%S%' AND NROLEITO NOT LIKE '%DAY%'   AND NROLEITO NOT LIKE '%PPP%' AND NROLEITO NOT LIKE '%VIR%' ))
     group by idunidatend) LE ON LE.IDUNIDATEND = U1.IDUNIDATEND
     
     
UNION ALL


 SELECT 'PRIVADO' TIPO, SYSDATE DATA, U1.IDUNIDATEND SETOR, NVL(LEITOS_OCUPADOS, 0) OCUPADOS, NVL(LEITOS_LIVRES,0) LIVRES, NVL(LEITOS_SETOR,0) LEITOS_SETOR, NVL(EXTRAS,0) EXTRAS
   
   FROM SZUNIDATEND U1 
    LEFT OUTER JOIN
  (--LEITOS OCUPADOS NO DIA
     SELECT count(*) LEITOS_OCUPADOS, idunidatend
      FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%PRIVADO%' AND 
      (STATUSLEITO LIKE 'O' AND NROLEITO NOT LIKE '%ALC%'  AND NROLEITO NOT LIKE '%RPA%' AND NROLEITO NOT LIKE '%MAC%'  AND BLOQLEITO NOT LIKE '%I%'  AND BLOQLEITO NOT LIKE '%S%' AND NROLEITO NOT LIKE '%DAY%'  AND NROLEITO NOT LIKE '%PPP%' AND NROLEITO NOT LIKE '%VIR%' ))
      group by idunidatend) O ON O.IDUNIDATEND = U1.IDUNIDATEND
      
      LEFT JOIN
   
   (--LEITOS LIVRES
     SELECT count(*) LEITOS_LIVRES, IDUNIDATEND
      FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%PRIVADO%' AND 
       (STATUSLEITO LIKE 'L' OR STATUSLEITO LIKE 'A' ) AND (NROLEITO NOT LIKE '%ALC%' AND NROLEITO NOT LIKE '%RPA%'AND NROLEITO NOT LIKE '%MAC%'  AND BLOQLEITO NOT LIKE '%S%' AND BLOQLEITO NOT LIKE '%I%' AND NROLEITO NOT LIKE '%DAY%'  AND NROLEITO NOT LIKE '%VIR%'))
      group by idunidatend) L ON L.IDUNIDATEND = U1.IDUNIDATEND
      
      LEFT JOIN 
        
   (--LEITOS DO SETOR
    SELECT COUNT(*) LEITOS_SETOR, IDUNIDATEND
    FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%PRIVADO%' AND 
       STATUSLEITO <> 'I' AND (NROLEITO NOT LIKE '%ALC%' AND NROLEITO NOT LIKE '%RPA%'AND NROLEITO NOT LIKE '%MAC%'AND BLOQLEITO NOT LIKE '%I%'   AND BLOQLEITO NOT LIKE '%S%' AND NROLEITO NOT LIKE '%DAY%'  AND NROLEITO NOT LIKE '%PPP%' AND NROLEITO NOT LIKE '%VIR%' ))
     group by idunidatend) LS ON LS.IDUNIDATEND = U1.IDUNIDATEND
    
      LEFT JOIN 
    
   (--LEITOS EXTRAS
    SELECT COUNT(*) EXTRAS, IDUNIDATEND
    FROM (SELECT * FROM SZLEITO L
      INNER JOIN SZCENTROCUSTO CC ON L.CODCENCUSTOS = CC.CODIGO
      WHERE
      CC.DESCRICAO LIKE '%PRIVADO%' AND 
     STATUSLEITO <> 'I'
     AND NROLEITO LIKE '%%EX%%' AND (NROLEITO NOT LIKE '%ALC%' AND NROLEITO NOT LIKE '%RPA%' AND NROLEITO NOT LIKE '%MAC%' AND BLOQLEITO NOT LIKE '%I%' AND BLOQLEITO NOT LIKE '%S%' AND NROLEITO NOT LIKE '%DAY%'  AND NROLEITO NOT LIKE '%PPP%' AND NROLEITO NOT LIKE '%VIR%' ))
     group by idunidatend) LE ON LE.IDUNIDATEND = U1.IDUNIDATEND;


  LINHA_OCUPACAO CUR_OCUPACAO%Rowtype;

BEGIN

    delete from T_CENSO_HOSPITALAR where TO_DATE(data_inf) = TO_DATE(SYSDATE);
    OPEN CUR_OCUPACAO;

    LOOP
        FETCH CUR_OCUPACAO into LINHA_OCUPACAO;
        EXIT WHEN CUR_OCUPACAO%NOTFOUND;
        INSERT INTO RM.T_CENSO_HOSPITALAR VALUES (LINHA_OCUPACAO.DATA ,LINHA_OCUPACAO.SETOR, LINHA_OCUPACAO.OCUPADOS, LINHA_OCUPACAO.LEITOS_SETOR, LINHA_OCUPACAO.LIVRES,  LINHA_OCUPACAO.EXTRAS, LINHA_OCUPACAO.TIPO );

     END LOOP;
    COMMIT;

END PROC_ATUALIZA_OCUPACAO;
