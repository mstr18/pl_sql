--procedure ORACLE

create or replace PROCEDURE PROC_DIARIAS
IS
CURSOR CUR_DIARIAS
     IS
     -- Esse cursor, retorna os pacientes de convênios internados atualmente e verifica a correspondência da diária liberada nas condições contratuais do convênio a definição do usuário
     
     SELECT PARC.SEQPARCIAL, PARC.NUMEROCONTA, PARC.SEQUENCIALCONTA, tab.CODESPECIALIDADE, tab.CODGRUPOITENS, tab.CODITEM, TAB.DESCITEM, SYSDATE , LEIT.CODCENCUSTOS, max(tab.valortabela) VALOR, loc.codlocaluso
        FROM SZPARCIALATEND PARC
            INNER JOIN SZATENDIMENTO ATD ON ATD.NUMEROCONTA = PARC.NUMEROCONTA AND ATD.SEQUENCIALCONTA = PARC.SEQUENCIALCONTA
            INNER JOIN SZLEITO LEIT ON ATD.CODLEITO = LEIT.CODLEITO
            INNER JOIN SZCONDCONTRAT CONTRAT ON CONTRAT.CODCONVENIO = ATD.CODCOMPRADOR and CONTRAT.idunidatend = 3
            INNER JOIN szcondcontratdiaria CONTDIARIA ON CONTDIARIA.CODCONVENIO = CONTRAT.codconvenio AND CONTDIARIA.CODTIPOCONTRATO = CONTRAT.CODTIPOCONTRATO and atd.codplano = CONTDIARIA.codplano
            inner join sztabprocserv tab on tab.codtabela = CONTRAT.codtabservicos and (CONTDIARIA.CODESPECIALIDADE||CONTDIARIA.CODGRUPOITENS||CONTDIARIA.CODITEM) = (tab.CODESPECIALIDADE||tab.CODGRUPOITENS||tab.CODITEM)
            inner join szlocalfat loc on loc.codclasseacomodacao = leit.codclasseacomodacao and loc.codcoligada = leit.codcoligada
            WHERE PARC.DATAFINAL IS NULL 
        AND PARC.STATUS IS NULL 
        AND (ATD.STATUSCONTA IS NULL OR ATD.STATUSCONTA ='F')
        AND PARC.CODCONVENIO NOT IN (494, 3087, 25, 592)
        AND ATD.DATASAIDA IS NULL
        AND ATD.TIPOPACIENTE <> 'R'
        AND LEIT.CODDIARIAPAC = (CONTDIARIA.CODESPECIALIDADE||CONTDIARIA.CODGRUPOITENS||CONTDIARIA.CODITEM)
        
      group by PARC.SEQPARCIAL, PARC.NUMEROCONTA, PARC.SEQUENCIALCONTA, tab.CODESPECIALIDADE, tab.CODGRUPOITENS, tab.CODITEM, TAB.DESCITEM,SYSDATE,LEIT.CODCENCUSTOS, loc.codlocaluso ;
      

  LINHA_DIARIAS CUR_DIARIAS%Rowtype;
  P_INCREMENTO INT;

BEGIN

 --Esse select retorna o valor maximo do sequencial de itens lançados à tabela de diárias
   SELECT MAX(SEQDEBITODIARIA)INTO P_INCREMENTO FROM SZATENDDIARIAS;

    OPEN CUR_DIARIAS;

    LOOP
        FETCH CUR_DIARIAS into LINHA_DIARIAS;
        P_INCREMENTO := P_INCREMENTO+1;
        EXIT WHEN CUR_DIARIAS%NOTFOUND;
        -- O insert é realizado nas contas resgatadas pelo SELECT acima, e se constam ali, então os pacientes estão internados, portanto, precisam da diária lançada
        Insert into SZATENDDIARIAS (CODCOLIGADA,NUMEROCONTA,SEQUENCIALCONTA,SEQDEBITODIARIA,DISCRIMINACAODIARIA,CODESPECIALIDADE,CODGRUPOITENS,CODITEM,QUANTIDADEDIARIAS,CHDIARIAS,VALORCHDIARIAS,VALORDIARIAS,VALORTOTALDIARIAS,STATUS,DATADIARIA,CODGGASTO,STATUSPENDENCIA,TIPOTABELAPTU,VALORCUSTOOPERPTU,CODUNIMEDPRESTPTU,CODPRESTREQPTU,VALORADICSERVPTU,VALORADICCUSTOOPERPTU,CODESPECMEDICAPTU,CODUNIMEDAUTPTU,NOMEPRESTPTU,DATAULTIMAALTERACAO,RESPULTIMAALTERACAO,CODCENTCUSTRESULTADO,VALORCUSTOUNITARIO,ESTORNADO,INCLUIDOPACOTE,LOCALUSO,DATAESTORNO,RESPESTORNO,ESPECIAL,EXIGELIBERACAO,IDENTIFICADO,IDEQUIVAL,SEQPARCIAL,PERCCOBCONV,VALORPAC,CODCCUSTO,SH,SP,SADT,CUSTOS,INSUMOS,RECCREATEDBY,RECCREATEDON,RECMODIFIEDBY,RECMODIFIEDON,ATO,SEQCONTROLEGABARITO,SEMINFOPGTO) values
        ('1',LINHA_DIARIAS.numeroconta,LINHA_DIARIAS.sequencialconta,P_INCREMENTO,LINHA_DIARIAS.DESCITEM,LINHA_DIARIAS.CODESPECIALIDADE,LINHA_DIARIAS.CODGRUPOITENS,LINHA_DIARIAS.CODITEM,'1',null,'0,01',LINHA_DIARIAS.VALOR,LINHA_DIARIAS.VALOR,null,to_date(SYSDATE,'DD/MM/RR'),'02',null,null,null,null,null,null,null,null,null,null,to_date(SYSDATE,'DD/MM/RR'),'062613',LINHA_DIARIAS.CODCENCUSTOS,'0',null,null,LINHA_DIARIAS.CODlocaluso,null,null,null,'N','T',null,LINHA_DIARIAS.SEQPARCIAL,null,null,null,null,null,null,null,null,'062613',to_date(SYSDATE,'DD/MM/RR'),'062613',to_date(SYSDATE,'DD/MM/RR'),null,null,null);

     END LOOP;
    COMMIT;

END PROC_DIARIAS;
